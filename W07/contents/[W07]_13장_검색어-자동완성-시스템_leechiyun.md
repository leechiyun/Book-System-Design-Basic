# 13장. 검색어 자동완성 시스템

## 1단계. 문제 이해 및 설계 범위 확정

- **요구사항**
    - 빠른 응답 속도: 100ms 이하
    - 연관성: 입력한 단어와 연관된 것
    - 정렬: 시스템 계산 결과 → 인기도 등 순위 모델에 의해 정렬
    - 규모 확장성: 시스템은 많은 트래픽을 감당할 수 있도록 확장 가능
    - 고가용성: 시스템의 일부에 장애가 발생하거나, 느려지거나, 예상치 못한 네트워크 문제가 생겨도 시스템은 계속 사용 가능

- **개략적 규모 추정**
    - 일간 능동 사용자(DAU) : 1천만 명
    - 평균적으로 한 사용자는 매일 10건의 검색
    - 질의할 때마다 평균적으로 20바이트의 데이터 입력
        - 문자 인코딩 방법 ASCII 사용
        - 질의문은 평균적으로 4개 단어(5글자)로 이루어진다
        - 질의당 평균 4 x 5 = 20바이트
    - 검색당 20건의 요청이 일어남
        - 글자수를 입력할때마다 서버에 요청됨
        - (1천만 사용자 x 10질의 / 일 x 20자 / 24시간 / 3600초) ⇒ 24,000건
        - 최대 QPS = QPS x 2 = 48,000
        - 질의 가운데 20% 정도는 신규 검색어라고 가정

## 2단계. 개략적 설계안 제시 및 동의 구하기

- **데이터 수집 서비스**
    - 빈도 테이블을 통해 사용자가 검색한 빈도수를 체크
        
        ![Untitled](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%20%E1%84%8C%E1%85%A1%E1%84%83%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%AA%E1%86%AB%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20425ed11ac3f6441f8d5538ed95d2bf07/Untitled.png)
        

- **질의 서비스**
    - query: 질의문 저장 필드
    - frequency: 질의문 사용 빈도 저장
    
    ![Untitled](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%20%E1%84%8C%E1%85%A1%E1%84%83%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%AA%E1%86%AB%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20425ed11ac3f6441f8d5538ed95d2bf07/Untitled%201.png)
    
    - DB자체의 쿼리문을 통해 검색할 수 있지만 매번 DB에서 가져오는 것은 비효율적

## 3단계. 상세 설계

- **트라이 자료구조**
    - 트리 형태의 자료구조
    - 루트 노드 = 빈 문자열
    - 글자 하나 저장 → 26개의 자식 노드
    - 접두어 문자열(prefix)
    
    ![Untitled](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%20%E1%84%8C%E1%85%A1%E1%84%83%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%AA%E1%86%AB%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20425ed11ac3f6441f8d5538ed95d2bf07/Untitled%202.png)
    
    (트라이 알고리즘에 빈도 테이블을 합침)
    
    → `시간복잡도 = O(p) + O(c) + O(clogc)` 
    
    - p: 접두어 길이
    - n: 트라이 안에 있는 노드 수
    - c: 주어진 노드의 자식 노드 수
    
    ![Untitled](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%20%E1%84%8C%E1%85%A1%E1%84%83%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%AA%E1%86%AB%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20425ed11ac3f6441f8d5538ed95d2bf07/Untitled%203.png)
    
    → 자식 노드의 인기 검색어를 합쳐 `O(1)`의 시간복잡도
    

- **질의 서비스**
    
    ![Untitled](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A2%E1%86%A8%E1%84%8B%E1%85%A5%20%E1%84%8C%E1%85%A1%E1%84%83%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%AA%E1%86%AB%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20425ed11ac3f6441f8d5538ed95d2bf07/Untitled%204.png)
    
    1. 검색 질의가 로드밸런서로 전송
    2. 로드밸런서는 해당 질의를 API 서버고 보냄
    3. API 서버는 트라이 캐시에서 데이터를 가져와 해당 요청에대한 자동완성 검색어 응답
    4. 데이터가 트라이 캐시에 없는 경우, 데이터를 DB에서 가져와 캐시에 채운다.